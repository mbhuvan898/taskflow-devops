name: Deploy TaskFlow

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - uses: actions/checkout@v4

      # 2️⃣ Build images
      - name: Build images
        run: |
          docker build -t taskflow-frontend ./client
          docker build -t taskflow-backend ./server

      # 3️⃣ Export images
      - name: Save images
        run: |
          docker save taskflow-frontend > frontend.tar
          docker save taskflow-backend > backend.tar

      # 4️⃣ Copy images to PUBLIC EC2
      - name: Copy images
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PUBLIC_HOST }}
          username: ubuntu"
          key: ${{ secrets.PUBLIC_SSH_KEY }}
          source: "frontend.tar,backend.tar"
          target: "~/"

      # 5️⃣ Deploy FRONTEND (public)
      - name: Deploy frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PUBLIC_HOST }}
          username: ubuntu
          key: ${{ secrets.PUBLIC_SSH_KEY }}
          script: |
            docker load < frontend.tar
            docker rm -f taskflow-frontend || true
            docker run -d -p 80:80 --name taskflow-frontend taskflow-frontend

      # 6️⃣ Deploy BACKEND via bastion using ENV_FILE
      - name: Deploy backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PUBLIC_HOST }}
          username: ubuntu
          key: ${{ secrets.PUBLIC_SSH_KEY }}
          script: |
            echo "${{ secrets.ENV_FILE }}" > backend.env

            scp -o StrictHostKeyChecking=no -i private-test.pem backend.tar ubuntu@${{ secrets.PRIVATE_IP }}:~
            scp -o StrictHostKeyChecking=no -i private-test.pem backend.env ubuntu@${{ secrets.PRIVATE_IP }}:~

            ssh -o StrictHostKeyChecking=no -i private-test.pem ubuntu@${{ secrets.PRIVATE_IP }} << 'EOF'
              docker load < backend.tar
              docker rm -f taskflow-backend || true
              docker run -d -p 5000:5000 \
                --env-file backend.env \
                --name taskflow-backend \
                taskflow-backend
            EOFname: Deploy TaskFlow

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout
      - uses: actions/checkout@v4

      # 2️⃣ Build images
      - name: Build images
        run: |
          docker build -t taskflow-frontend ./client
          docker build -t taskflow-backend ./server

      # 3️⃣ Export images
      - name: Save images
        run: |
          docker save taskflow-frontend > frontend.tar
          docker save taskflow-backend > backend.tar

      # 4️⃣ Copy images to PUBLIC EC2
      - name: Copy images
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.PUBLIC_HOST }}
          username: ubuntu
          key: ${{ secrets.PUBLIC_SSH_KEY }}
          source: "frontend.tar,backend.tar"
          target: "~/"

      # 5️⃣ Deploy FRONTEND (public)
      - name: Deploy frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PUBLIC_HOST }}
          username: ubuntu
          key: ${{ secrets.PUBLIC_SSH_KEY }}
          script: |
            docker load < frontend.tar
            docker rm -f taskflow-frontend || true
            docker run -d -p 80:80 --name taskflow-frontend taskflow-frontend

      # 6️⃣ Deploy BACKEND via bastion using ENV_FILE
      - name: Deploy backend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PUBLIC_HOST }}
          username: ubuntu
          key: ${{ secrets.PUBLIC_SSH_KEY }}
          script: |
            echo "${{ secrets.ENV_FILE }}" > backend.env

            scp -o StrictHostKeyChecking=no -i private-test.pem backend.tar ubuntu@${{ secrets.PRIVATE_IP }}:~
            scp -o StrictHostKeyChecking=no -i private-test.pem backend.env ubuntu@${{ secrets.PRIVATE_IP }}:~

            ssh -o StrictHostKeyChecking=no -i private-test.pem ubuntu@${{ secrets.PRIVATE_IP }} << 'EOF'
              docker load < backend.tar
              docker rm -f taskflow-backend || true
              docker run -d -p 5000:5000 \
                --env-file backend.env \
                --name taskflow-backend \
                taskflow-backend
            EOF