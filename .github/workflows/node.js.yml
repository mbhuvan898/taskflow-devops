name: Deploy TaskFlow

on:
  push:
    branches:
      - main

jobs:

  # ─────────────────────────────────────────────
  # JOB 1 — Frontend → S3 + CloudFront
  # ─────────────────────────────────────────────
  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install frontend deps
        run: cd client && npm ci

      - name: Build frontend
        run: cd client && npm run build

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          aws s3 sync client/build/ s3://${{ secrets.S3_BUCKET_NAME }} --delete

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
          echo "✅ Frontend deployed"

  # ─────────────────────────────────────────────
  # JOB 2 — Backend → Private EC2 via Bastion
  # ─────────────────────────────────────────────
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: deploy-frontend

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Build backend Docker image
        run: |
          cd server
          docker build -t taskflow-backend .

      - name: Save Docker image
        run: docker save taskflow-backend > backend.tar

      # ── Step 1: Copy image to Bastion (public EC2) ──
      - name: Copy image to Bastion
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ secrets.BASTION_HOST }}
          username: ubuntu
          key:      ${{ secrets.BASTION_SSH_KEY }}
          source:   "backend.tar"
          target:   "/home/ubuntu/"

      # ── Step 2: Bastion → copy image to Backend EC2 → deploy ──
      - name: Deploy via Bastion to Backend EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host:     ${{ secrets.BASTION_HOST }}
          username: ubuntu
          key:      ${{ secrets.BASTION_SSH_KEY }}
          script: |
            # Write private key for backend EC2
            echo "${{ secrets.PRIVATE_SSH_KEY }}" > ~/.ssh/backend-key.pem
            chmod 600 ~/.ssh/backend-key.pem

            # Copy docker image from bastion to backend EC2
            scp -o StrictHostKeyChecking=no \
              -i ~/.ssh/backend-key.pem \
              /home/ubuntu/backend.tar \
              ubuntu@${{ secrets.BACKEND_PRIVATE_IP }}:~/

            # SSH into backend EC2 and deploy
            ssh -o StrictHostKeyChecking=no \
              -i ~/.ssh/backend-key.pem \
              ubuntu@${{ secrets.BACKEND_PRIVATE_IP }} \
              "docker load < ~/backend.tar && \
               docker rm -f taskflow-backend || true && \
               docker run -d \
                 --name taskflow-backend \
                 --network host \
                 --restart always \
                 --env-file /home/ubuntu/backend.env \
                 taskflow-backend && \
               sleep 5 && \
               curl -f http://localhost:5000/api/health && \
               echo '✅ Backend deployed and healthy'"

            # Cleanup from bastion
            rm -f ~/.ssh/backend-key.pem /home/ubuntu/backend.tar